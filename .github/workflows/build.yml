name: "Build WildFlower GKI"

env:
  OUT_DIR: "out"
  KERNEL_VERSION: "5.15"
  ANDROID_VERSION: "13"

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-kernels:
    name: "Build GKI Kernel"
    runs-on: ubuntu-latest
    outputs:
      build_start_time: ${{ steps.set_time.outputs.start_time }}
    
    env:
      KERNEL_LOC_DIR: "common_gki"
      KERNEL_NAME: "common"
      KERNEL_REPO: "https://android.googlesource.com/kernel/common"
      KERNEL_BRANCH: "android13-5.15-lts"
      DEFCONFIG_NAME: "gki_defconfig"
      WORK_DIR: ${{ github.workspace }}

    steps:
      - name: "Set build start time"
        id: set_time
        run: |
          START_TIME=$(date +%s)
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "BUILD_START_TIME=$START_TIME" >> $GITHUB_ENV

      - name: "Send Telegram build started"
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          RUN_NUMBER="${{ github.run_number }}"
          BRANCH="${{ env.KERNEL_BRANCH }}"
          
          MESSAGE="<b>üöÄ WildFlower Build Started</b>%0A%0A"
          MESSAGE="${MESSAGE}<b>üì¶ Variant:</b> ksu%0A"
          MESSAGE="${MESSAGE}<b>üìÅ Repository:</b> ${{ github.repository }}%0A"
          MESSAGE="${MESSAGE}<b>üìç Branch:</b> ${BRANCH}%0A"
          MESSAGE="${MESSAGE}<b>üîÑ Trigger:</b> ${{ github.event_name }}%0A"
          MESSAGE="${MESSAGE}<b>üÜî Run:</b> #${RUN_NUMBER}%0A"
          MESSAGE="${MESSAGE}<b>‚è∞ Started:</b> $(TZ='UTC' date +'%Y-%m-%d %H:%M UTC')%0A"
          MESSAGE="${MESSAGE}<b>‚è≥ Status:</b> Initializing..."
          
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" || true

      - name: "Setup workspace"
        run: |
          mkdir -p ${{ env.KERNEL_LOC_DIR }}
          echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV
          sudo apt-get update -qq
          sudo apt-get install -y repo rsync aria2 bc bison build-essential flex git libelf-dev libssl-dev curl jq

      - name: "Setup SWAP 8GB"
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 8
          
      - name: "Tune Swap"
        run: |
          echo "vm.swappiness=80" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p

      - name: "Clone kernel source"
        working-directory: ./${{ env.KERNEL_LOC_DIR }}
        run: |
          git clone --recursive --branch ${{ env.KERNEL_BRANCH }} \
            ${{ env.KERNEL_REPO }} ${{ env.KERNEL_NAME }} --depth=1

      - name: "Cherry-pick Custom Commits"
        working-directory: ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}
        run: |
          echo "Cherry-picking custom commits into ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}..." 
          
          # Set gitconfig
          git config --global user.name "mizdrake14"
          git config --global user.email "mizdrake14@gmail.com"

          # Fetch the specific branch from the remote repository
          git fetch https://github.com/mizdrake7/WILDFlower-android13-5.15-common-GKI feb1

          # Cherry-pick the specified range of commits
          git cherry-pick 223757704b54f1b33e9b5b1bb7e99ab12b28e6ff^..8a6dbe7968b316c942596108e92df95e4cab04cb           

      - name: "Initialize AOSP repo and toolchains"
        working-directory: ${{ env.WORK_DIR }}
        run: |
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android13-5.15-lts --depth=1
          repo sync --optimized-fetch --prune --no-clone-bundle --no-tags -j$(nproc --all)
          
          rm -rf .repo
          rm -rf common

          # ZyC Clang Implementation (Replaced aria2 logic)
          TOOLCHAIN="${{ env.WORK_DIR }}/prebuilts/clang/host/linux-x86/zyc-clang"
          wget "$(curl -s https://raw.githubusercontent.com/ZyCromerZ/Clang/main/Clang-main-link.txt)" -O "zyc-clang.tar.gz"
          mkdir -p ${TOOLCHAIN} && tar -xf zyc-clang.tar.gz -C ${TOOLCHAIN}
          
          # Fix: Export path so build tools can find clang
          echo "${TOOLCHAIN}/bin" >> $GITHUB_PATH
          rm -rf zyc-clang.tar.gz

          rm -rf prebuilts/clang/host/linux-x86/clang-3289846
          rm -rf prebuilts/clang/host/linux-x86/clang-r450784e
          rm -rf prebuilts/clang/host/linux-x86/clang-stable
          
          sed -i \
           -e 's/^BRANCH=.*/BRANCH=android13-5.15/' \
           -e 's/^CLANG_VERSION=.*/CLANG_VERSION=zyc-clang/' \
           ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}/build.config.constants
          
          sed -i '/^POST_DEFCONFIG_CMDS="check_defconfig"/d' ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}/build.config.gki || true

      - name: "Setup Baseband-guard (BBG)"
        working-directory: ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}
        run: |
          git clone -q --depth=1 https://github.com/vc-teahouse/Baseband-guard.git
          ln -sf ../Baseband-guard security/baseband-guard
          
          grep -q "baseband-guard" security/Makefile || \
            echo 'obj-$(CONFIG_BBG) += baseband-guard/' >> security/Makefile
          
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' security/Kconfig
          
          grep -q "baseband-guard/Kconfig" security/Kconfig || \
            sed -i '/source "security\/keys\/Kconfig"/a source "security/baseband-guard/Kconfig"' security/Kconfig

      - name: "Setup Wild-KSU with SUSFS"
        working-directory: ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}
        run: |
          set -e
          
          rm -rf ./KernelSU ./drivers/kernelsu ./Wild_KSU
          
          echo "Installing Wild-KSU..."
          curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s stable
          
          if [ ! -d "Wild_KSU" ]; then
            echo "ERROR: Wild_KSU directory not found!"
            exit 1
          fi
          
          echo "Cloning SUSFS4KSU..."
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android13-5.15
          
          if [ ! -d "susfs4ksu" ]; then
            echo "ERROR: SUSFS4KSU clone failed!"
            exit 1
          fi
          
          SUSFS_PATCH="susfs4ksu/kernel_patches/50_add_susfs_in_gki-android13-5.15.patch"
          
          if [ -f "$SUSFS_PATCH" ]; then
            if patch -p1 --forward < "$SUSFS_PATCH"; then
              echo "SUSFS kernel patch applied"
            else
              echo "Patch had some issues, continuing..."
            fi
          fi
          
          mkdir -p fs include/linux
          
          if [ -f "susfs4ksu/kernel_patches/fs/susfs.c" ]; then
            cp -f susfs4ksu/kernel_patches/fs/susfs.c fs/susfs.c
          else
            echo "ERROR: fs/susfs.c not found!"
            exit 1
          fi
          
          if [ -f "susfs4ksu/kernel_patches/include/linux/susfs.h" ]; then
            cp -f susfs4ksu/kernel_patches/include/linux/susfs.h include/linux/susfs.h
          else
            echo "ERROR: include/linux/susfs.h not found!"
            exit 1
          fi
          
          if [ -f "susfs4ksu/kernel_patches/include/linux/susfs_def.h" ]; then
            cp -f susfs4ksu/kernel_patches/include/linux/susfs_def.h include/linux/susfs_def.h
          fi
          
          if [ -d "susfs4ksu/kernel_patches/KernelSU/kernel" ]; then
            cp -rf susfs4ksu/kernel_patches/KernelSU/kernel/* Wild_KSU/kernel/ || true
          fi
          
          KSU_C_FILE="Wild_KSU/kernel/ksu.c"
          
          if [ ! -f "$KSU_C_FILE" ]; then
            echo "ERROR: $KSU_C_FILE not found!"
            exit 1
          fi
          
          if ! grep -q "susfs_init" "$KSU_C_FILE" 2>/dev/null; then
            if ! grep -q "#include <linux/susfs.h>" "$KSU_C_FILE"; then
              sed -i '/#include <linux\/fs\.h>/a #include <linux/susfs.h>' "$KSU_C_FILE"
            fi
            
            if ! grep -q "susfs_init()" "$KSU_C_FILE"; then
              sed -i '/ksu_core_init();/a \\tsusfs_init();' "$KSU_C_FILE" || \
              sed -i '/int __init ksu_init(/,/^}/{ /return 0;/i \\tsusfs_init(); }' "$KSU_C_FILE"
            fi
          fi
          
          if [ ! -L "drivers/kernelsu" ] && [ ! -d "drivers/kernelsu" ]; then
            ln -sf ../Wild_KSU drivers/kernelsu
          fi
          
          rm -rf susfs4ksu

      - name: "Add kernel configurations"
        working-directory: ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}
        run: |
          CONFIG_FILE="arch/arm64/configs/${{ env.DEFCONFIG_NAME }}"
          
          cat >> "$CONFIG_FILE" << 'EOF'
          CONFIG_KALLSYMS=y
          CONFIG_KSU=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_OVERLAY_FS=y
          CONFIG_OVERLAY_FS_REDIRECT_DIR=y
          CONFIG_OVERLAY_FS_REDIRECT_ALWAYS_FOLLOW=y
          CONFIG_OVERLAY_FS_INDEX=y
          CONFIG_OVERLAY_FS_XINO_AUTO=y
          CONFIG_OVERLAY_FS_METACOPY=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_SU=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_TCP_CONG_WESTWOOD=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_DEFAULT_WESTWOOD=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          EOF
          
          echo "‚úÖ Kernel configurations added successfully"
          
      - name: "Configure kernel name and remove dirty"
        working-directory: ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}
        run: |
          export TZ="Asia/Jakarta"
          CURRENT_TIME=$(date -u +"%a %b %d %H:%M:%S UTC %Y")
          
          # Changed to WildFlower
          KERNEL_SUFFIX="-WildFlower"
          
          echo "CURRENT_TIME=$CURRENT_TIME"
          echo "KERNEL_SUFFIX=$KERNEL_SUFFIX"
          
          sed -i "\$s|echo \"\\\$res\"|echo \"\\\$res${KERNEL_SUFFIX}\"|" ./scripts/setlocalversion
          
          perl -pi -e "s{UTS_VERSION=\"\\\$\(echo \\\$UTS_VERSION \\\$CONFIG_FLAGS \\\$TIMESTAMP \\| cut -b -\\\$UTS_LEN\)\"}{UTS_VERSION=\"#1 SMP PREEMPT $CURRENT_TIME\"}" ./scripts/mkcompile_h
          
          sed -i 's/-dirty//' ./scripts/setlocalversion
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "WildFlower: Clean Dirty Flag" || true

      - name: "Fix ABI and build configs"
        working-directory: ${{ env.WORK_DIR }}
        run: |
          if [ -f "build/abi/compare_to_symbol_list" ]; then
            mv build/abi/compare_to_symbol_list build/abi/compare_to_symbol_list.disabled
          fi
          
          cat > build/abi/compare_to_symbol_list << 'EOF'
          #!/bin/bash
          echo "ABI checking disabled for custom kernel build"
          exit 0
          EOF
          chmod +x build/abi/compare_to_symbol_list
          
          sed -i 's/BUILD_SYSTEM_DLKM=1/BUILD_SYSTEM_DLKM=0/' ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}/build.config.gki.aarch64
          sed -i '/MODULES_ORDER=android\/gki_aarch64_modules/d' ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}/build.config.gki.aarch64
          sed -i '/KMI_SYMBOL_LIST_STRICT_MODE/d' ${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}/build.config.gki.aarch64

      - name: "Build kernel"
        id: build
        working-directory: ${{ env.WORK_DIR }}
        timeout-minutes: 45
        run: |
          set -e
          echo "üöÄ Starting kernel build with $(nproc) cores..."
          
          export LTO=thin
          export SKIP_ABI_CHECKS=1
          export SKIP_KMI_CHECK=1
          
          START_BUILD=$(date +%s)
          
          if ! BUILD_CONFIG=${{ env.KERNEL_LOC_DIR }}/${{ env.KERNEL_NAME }}/build.config.gki.aarch64 \
            build/build.sh -j$(nproc); then
            echo "BUILD_FAILED=1" >> $GITHUB_ENV
            exit 1
          fi
          
          END_BUILD=$(date +%s)
          DURATION=$((END_BUILD - START_BUILD))
          echo "‚úÖ Build completed in $((DURATION / 60))m $((DURATION % 60))s"
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

      - name: "Verify kernel version"
        working-directory: ${{ env.WORK_DIR }}/out/dist
        run: |
          echo "üîç VERIFYING KERNEL VERSION"
          
          VERSION_FULL=$(strings Image | grep "Linux version 5" | head -1)
          echo "Full version string: $VERSION_FULL"
          
          if echo "$VERSION_FULL" | grep -q "dirty"; then
            echo "‚ùå ERROR: Kernel contains -dirty!"
            exit 1
          fi
          
          VERSION_CLEAN=$(echo "$VERSION_FULL" | sed 's/Linux version //' | sed 's/ (.*//')
          echo "‚úÖ Clean kernel version: $VERSION_CLEAN"
          
          echo "KERNEL_VERSION=$VERSION_CLEAN" >> $GITHUB_ENV
          echo "$VERSION_CLEAN" > kernel_version.txt

      - name: "Copy kernel image"
        working-directory: ${{ env.WORK_DIR }}/out/dist
        run: |
          cp Image "Image.WildFlower"
          echo "üì¶ Kernel image:"
          ls -lh Image.WildFlower

      - name: "Upload kernel artifact"
        uses: actions/upload-artifact@v4
        with:
          name: wildflower-kernel
          path: |
            ${{ env.WORK_DIR }}/out/dist/Image.WildFlower
            ${{ env.WORK_DIR }}/out/dist/kernel_version.txt
          retention-days: 1

  package-kernel:
    name: "Package Kernel"
    runs-on: ubuntu-latest
    needs: [build-kernels]
    if: success()
    
    steps:
      - name: "Download kernel artifact"
        uses: actions/download-artifact@v4
        with:
          name: wildflower-kernel
          path: ./artifacts/

      - name: "Read kernel version"
        run: |
          if [ -f "./artifacts/kernel_version.txt" ]; then
            KERNEL_VERSION=$(cat ./artifacts/kernel_version.txt)
            echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
            echo "üìã Detected kernel version: $KERNEL_VERSION"
          else
            echo "‚ö†Ô∏è kernel_version.txt not found, using placeholder"
            echo "KERNEL_VERSION=5.15.x-unknown" >> $GITHUB_ENV
          fi

      - name: "Create ZIP package"
        run: |
          set -e
          echo "üì¶ Creating AnyKernel3 package..."
          
          git clone --depth=1 https://github.com/superuseryu/AnyKernel3
          
          if [ ! -f "./artifacts/Image.WildFlower" ]; then
            echo "ERROR: Image.WildFlower not found in artifacts!"
            ls -la ./artifacts/
            exit 1
          fi
          
          cp ./artifacts/Image.WildFlower AnyKernel3/
          
          DATE_TAG=$(date +'%Y%m%d')
          ZIP_NAME="WildFlower_GKI_${DATE_TAG}.zip"
          
          cd AnyKernel3
          zip -r9 "../$ZIP_NAME" * -x .git/*
          cd ..
          
          ZIP_SIZE=$(stat -c%s "$ZIP_NAME")
          ZIP_SIZE_MB=$(echo "scale=2; $ZIP_SIZE / 1024 / 1024" | bc)
          ZIP_SHA256=$(sha256sum "$ZIP_NAME" | cut -d' ' -f1)
          ZIP_SHA256_SHORT=$(echo "$ZIP_SHA256" | cut -c1-16)
          
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "ZIP_SIZE_MB=$ZIP_SIZE_MB" >> $GITHUB_ENV
          echo "ZIP_SHA256=$ZIP_SHA256" >> $GITHUB_ENV
          echo "ZIP_SHA256_SHORT=$ZIP_SHA256_SHORT" >> $GITHUB_ENV
          echo "DATE_TAG=$DATE_TAG" >> $GITHUB_ENV
          
          echo "‚úÖ Package created: $ZIP_NAME ($ZIP_SIZE_MB MB)"
          echo "üìä Size: $ZIP_SIZE_MB MB"
          echo "üîê SHA256: $ZIP_SHA256"
          
          unzip -t "$ZIP_NAME"
          file "$ZIP_NAME"
          ls -la "$ZIP_NAME"

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.ZIP_NAME }}
          tag_name: "WildFlower_Build"

      - name: "Send Telegram success notification"
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/WildFlower_Build"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          BUILD_END_TIME=$(date +%s)
          BUILD_START_TIME="${{ needs.build-kernels.outputs.build_start_time }}"
          DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
          DURATION_MIN=$((DURATION / 60))
          DURATION_SEC=$((DURATION % 60))
          
          SHORT_SHA=$(echo "${{ env.ZIP_SHA256 }}" | cut -c1-20)
          
          MESSAGE="<b>üéâ WildFlower Success!</b>%0A%0A"
          MESSAGE="${MESSAGE}<b>üì¶ File:</b> <code>${{ env.ZIP_NAME }}</code>%0A"
          MESSAGE="${MESSAGE}<b>üìä Size:</b> ${{ env.ZIP_SIZE_MB }} MB%0A"
          MESSAGE="${MESSAGE}<b>üîê SHA256:</b> <code>${SHORT_SHA}...</code>%0A"
          MESSAGE="${MESSAGE}<b>ü™ß Kernel:</b> <code>${{ env.KERNEL_VERSION }}</code>%0A"
          MESSAGE="${MESSAGE}<b>üîó Release:</b> <a href='${RELEASE_URL}'>click-here</a>%0A"
          MESSAGE="${MESSAGE}<b>üìù Logs:</b> <a href='${RUN_URL}'>View</a>%0A"
          MESSAGE="${MESSAGE}<b>üóìÔ∏è Build Time:</b> ${DURATION_MIN}m ${DURATION_SEC}s%0A"
          MESSAGE="${MESSAGE}<b>üìå Variant:</b> WildFlower%0A"
          MESSAGE="${MESSAGE}   - SUSFS ‡∂û%0A"
          MESSAGE="${MESSAGE}   - BBG%0A"
          MESSAGE="${MESSAGE}   - BBRv1 Westwood TCP%0A%0A"
          MESSAGE="${MESSAGE}<b>üì£ Author/Maintainer:</b> @superuseryu%0A%0A"
          MESSAGE="${MESSAGE}#kernel #gki #wildflower"
          
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true
          
          if (( $(echo "${{ env.ZIP_SIZE_MB }} < 50" | bc -l) )); then
            curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendDocument" \
              -F chat_id="$CHAT_ID" \
              -F document=@"${{ env.ZIP_NAME }}" \
              -F caption="$CAPTION"
          fi

  notify-failure:
    name: "Notify Failure"
    runs-on: ubuntu-latest
    needs: [build-kernels]
    if: always() && needs.build-kernels.result != 'success'
    steps:
      - name: "Send Telegram failure notification"
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          JOB_STATUS="${{ needs.build-kernels.result }}"
          
          if [ "$JOB_STATUS" = "cancelled" ]; then
            STATUS_ICON="‚ö†Ô∏è"
            STATUS_TEXT="Workflow Cancelled"
          elif [ "$JOB_STATUS" = "failure" ]; then
            STATUS_ICON="‚ùå"
            STATUS_TEXT="Build Failed"
          else
            STATUS_ICON="‚ùì"
            STATUS_TEXT="Unknown Status ($JOB_STATUS)"
          fi
          
          MESSAGE="<b>${STATUS_ICON} ${STATUS_TEXT}!</b>%0A%0A"
          MESSAGE="${MESSAGE}<b>üì¶ Variant:</b> wildflower%0A"
          MESSAGE="${MESSAGE}<b>üïê Time:</b> $(TZ='Asia/Jakarta' date +'%H:%M:%S WIB')%0A"
          MESSAGE="${MESSAGE}<b>üîó Logs:</b> <a href='${RUN_URL}'>View Logs</a>%0A"
          MESSAGE="${MESSAGE}<b>üìå Status:</b> ${JOB_STATUS}%0A"
          
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" || true
